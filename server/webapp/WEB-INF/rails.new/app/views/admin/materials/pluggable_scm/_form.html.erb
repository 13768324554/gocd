<%= render(:partial => "shared/flash_message") %>
<%= render :partial => "shared/config_save_actions" -%>

<% scm_config = scope[:material].getSCMConfig() %>
<%= form_for(scope[:material], :as => :material, :url => scope[:url], :html => {"novalidate"=> "novalidate", :id=> "material_form", :name=> "material_form", :method => scope[:method], :onsubmit => "return AjaxForm.jquery_ajax_submit(this);", :class => "popup_form"}) do |f| %>
    <% form_name_provider_obj = form_name_provider(f) %>
    <% plugged_material_angular_controller_element_id = form_name_provider_obj.css_id_for("angular_" + scm_config.getSCMType()) %>
    <% plugged_material_data_element_id = form_name_provider_obj.css_id_for("data_" + scm_config.getSCMType()) %>

    <%= md5_field %>

    <%= f.hidden_field com.thoughtworks.go.config.materials.PluggableSCMMaterialConfig::SCM_ID -%>

    <div class="form_content exec_task_editor">
        <%= render :partial => "admin/shared/global_errors.html", :locals => {:scope => {}} -%>
        <div id="material">
            <%= render :partial => 'shared/form_required_message.html', :locals => {:scope => {}} %>

            <h3><%= l.string('NAME') -%></h3>
            <div class="fieldset">
                <%= f.text_field com.thoughtworks.go.domain.scm.SCM::NAME, {:class => "form_input", :id => nil} -%>
                <%= error_message_on(scm_config, com.thoughtworks.go.domain.scm.SCM::NAME, :css_class => "form_error") %>
            </div>

            <h3><%= l.string("BASIC_SETTINGS") %></h3>
            <div class="task fieldset">
                <div id="<%= plugged_material_angular_controller_element_id %>" name="<%= plugged_material_angular_controller_element_id %>" class="plugged_material">
                    <div class="plugged_material_template required">
                        <%== scope[:meta_data_store].template(scope[:material].getPluginId()) %>
                    </div>

                    <span id="<%= plugged_material_data_element_id %>" class="plugged_material_data" style="display: none">
                        <%= com.google.gson.Gson.new.toJson(scm_config.getConfigAsMap()) %>
                    </span>
                </div>
            </div>

            <div class="fieldset">
                <%= f.check_box(com.thoughtworks.go.domain.scm.SCM::AUTO_UPDATE, {:include_blank => true, :class => "form_input"}, "true") -%>
                <label for="material_<%= com.thoughtworks.go.domain.scm.SCM::AUTO_UPDATE -%>"><%= l.string('SHOULD_AUTO_UPDATE') -%></label>
                <%= error_message_on(scm_config, com.thoughtworks.go.domain.scm.SCM::AUTO_UPDATE, :css_class => "form_error") %>
            </div>

            <h3><%= l.string('DESTINATION_DIR') -%></h3>
            <div class="fieldset">
                <%= f.text_field(com.thoughtworks.go.config.materials.PluggableSCMMaterialConfig::FOLDER, {:include_blank => true, :class => "form_input", :id => nil}) -%>
                <%= error_message_on(scope[:material], com.thoughtworks.go.config.materials.PluggableSCMMaterialConfig::FOLDER, :css_class => "form_error") %>
            </div>

            <h3><%= l.string("BLACKLIST") -%></h3>
            <div class="fieldset">
                <label><%= l.string("BLACKLIST_DESCRIPTION") -%></label>
                <% scope[:material].filter().each do |ignored_file|
                  error = ignored_file.errors().on(com.thoughtworks.go.config.materials.IgnoredFiles::PATTERN)
                  if error
                    scope[:material].errors().add(com.thoughtworks.go.config.materials.PluggableSCMMaterialConfig::FILTER, error)
                  end
                end %>

                <%= f.text_area(com.thoughtworks.go.config.materials.PluggableSCMMaterialConfig::FILTER, {:include_blank => true, :class => "form_input", :id => nil, :rows => 2}) -%>
                <%= error_message_on(scope[:material], com.thoughtworks.go.config.materials.PluggableSCMMaterialConfig::FILTER, :css_class => "form_error") %>
                <div class="clear"></div>
            </div>
        </div>
    </div>
    <%= render :partial => "shared/form_buttons.html", :locals => {:scope => {:submit_label => l.string("SAVE")}} %>
    <%= render :partial => 'shared/convert_tool_tips.html' %>

    <script type="text/javascript">
        jQuery(document).ready(function () {
            var form_name_prefix = "<%= form_name_provider_obj.form_name_prefix %>";
            var plugged_material_angular_controller_element_id = "<%= plugged_material_angular_controller_element_id %>";
            var plugged_material_data_element_id = "<%= plugged_material_data_element_id %>";
            new TaskPluginView().initialize(plugged_material_angular_controller_element_id, plugged_material_data_element_id, form_name_prefix);

            new TaskPluginView().bootstrapAngular();
        });
    </script>
<% end %>